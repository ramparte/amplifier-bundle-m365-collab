#!/usr/bin/env python3
"""Start an Amplifier session bound to an agent persona.

This script:
1. Loads the agent configuration
2. Creates a persona context file
3. Starts Amplifier with that context
4. Registers the session binding
"""

import argparse
import json
import os
import subprocess
import sys
import uuid
import yaml
from datetime import datetime, timezone
from pathlib import Path

CONFIG_DIR = Path.home() / ".m365-tenant"
CONFIG_FILE = CONFIG_DIR / "config.yaml"
SESSIONS_DIR = CONFIG_DIR / "sessions"
PERSONAS_DIR = CONFIG_DIR / "personas"


def load_config():
    return yaml.safe_load(CONFIG_FILE.read_text())


def get_agent(config, agent_name):
    for agent in config.get("agents", []):
        if agent["name"] == agent_name:
            return agent
    return None


def create_persona_context(agent):
    """Create a markdown context file for the agent persona."""
    PERSONAS_DIR.mkdir(exist_ok=True)
    
    persona_content = f'''# Agent Persona: {agent["display_name"]}

You are **{agent["display_name"]}**, a specialized AI agent in a multi-agent collaboration system.

## Your Role
- **Name**: {agent["name"]}
- **Role**: {agent["role"]}
- **Description**: {agent["description"]}

## Communication

You communicate with other agents and the controller via the M365 message board.

### Check for tasks assigned to you:
```bash
cd ~/.m365-tenant && uv run --with msal --with httpx --with pyyaml python m365-orchestrator messages --agent {agent["name"]}
```

### Post a status update:
```bash
cd /mnt/c/ANext/amplifier-toolkit/tools/m365-collab && uv run --with msal --with httpx python bin/m365-collab post-status --title "Update from {agent["name"]}" --text "Your status message"
```

### Claim and complete tasks:
```bash
# Claim a task
cd /mnt/c/ANext/amplifier-toolkit/tools/m365-collab && uv run --with msal --with httpx python bin/m365-collab claim-task --task-id <task-id>

# Complete a task
cd /mnt/c/ANext/amplifier-toolkit/tools/m365-collab && uv run --with msal --with httpx python bin/m365-collab complete-task --task-id <task-id> --result '{{"status": "done", "summary": "What you did"}}'
```

## Your Responsibilities

As a **{agent["role"]}**, you should:
'''

    if agent["role"] == "researcher":
        persona_content += '''
- Investigate problems thoroughly before suggesting solutions
- Gather information from multiple sources
- Document findings clearly
- Ask clarifying questions when requirements are unclear
'''
    elif agent["role"] == "implementer":
        persona_content += '''
- Build solutions based on specifications
- Write clean, well-documented code
- Test your implementations
- Report blockers promptly
'''
    elif agent["role"] == "reviewer":
        persona_content += '''
- Review code and designs for quality
- Check for security issues, bugs, and anti-patterns
- Provide constructive feedback
- Ensure standards are met
'''
    elif agent["role"] == "coordinator":
        persona_content += '''
- Break down complex tasks into manageable pieces
- Assign work to appropriate agents
- Track progress and resolve blockers
- Ensure smooth collaboration
'''

    persona_content += f'''
## Collaboration Guidelines

1. **Check for messages regularly** - Look for tasks assigned to you
2. **Claim before working** - Always claim a task before starting
3. **Update status** - Post status updates on longer tasks
4. **Complete properly** - Mark tasks complete with a summary
5. **Ask for help** - Post a message if you're blocked

## Environment Variables

The M365 credentials should be set in your environment:
- M365_TENANT_ID
- M365_CLIENT_ID  
- M365_CLIENT_SECRET

## Session Info

- Agent: {agent["name"]}
- Email: {agent["email"]}
- Started: {{timestamp}}
'''

    persona_file = PERSONAS_DIR / f"{agent['name']}.md"
    persona_file.write_text(persona_content.replace("{{timestamp}}", 
                                                     datetime.now().isoformat()))
    return persona_file


def register_session(agent_name, session_id):
    """Register the session binding."""
    SESSIONS_DIR.mkdir(exist_ok=True)
    session_file = SESSIONS_DIR / f"{agent_name}.json"
    
    session_info = {
        "agent": agent_name,
        "session_id": session_id,
        "started_at": datetime.now(timezone.utc).isoformat(),
        "status": "active",
        "pid": os.getpid(),
    }
    
    session_file.write_text(json.dumps(session_info, indent=2))
    return session_info


def main():
    parser = argparse.ArgumentParser(description="Start an agent session")
    parser.add_argument("agent", help="Agent name (e.g., agent-alpha)")
    parser.add_argument("--bundle", default="git+https://github.com/ramparte/my-amplifier@main",
                        help="Bundle to use")
    parser.add_argument("--dry-run", action="store_true", help="Just show what would be done")
    args = parser.parse_args()

    config = load_config()
    agent = get_agent(config, args.agent)
    
    if not agent:
        print(f"Error: Agent '{args.agent}' not found in config")
        print(f"Available agents: {[a['name'] for a in config.get('agents', [])]}")
        sys.exit(1)

    print(f"Starting session for: {agent['display_name']}")
    print(f"  Role: {agent['role']}")
    print(f"  Email: {agent['email']}")

    # Create persona context
    persona_file = create_persona_context(agent)
    print(f"  Persona: {persona_file}")

    # Generate session ID
    session_id = f"agent-{agent['name']}-{uuid.uuid4().hex[:8]}"
    
    if args.dry_run:
        print(f"\nDry run - would start Amplifier with:")
        print(f"  Bundle: {args.bundle}")
        print(f"  Session: {session_id}")
        print(f"  Persona context: {persona_file}")
        return

    # Register session
    register_session(args.agent, session_id)

    # Build amplifier command
    cmd = [
        "amplifier", "run",
        "--bundle", args.bundle,
        "--session-id", session_id,
    ]

    # Set up environment
    env = os.environ.copy()
    creds = json.loads((CONFIG_DIR / "credentials.json").read_text())
    env["M365_TENANT_ID"] = creds["tenant_id"]
    env["M365_CLIENT_ID"] = creds["app"]["client_id"]
    env["M365_CLIENT_SECRET"] = creds["app"]["client_secret"]
    env["AGENT_NAME"] = agent["name"]
    env["AGENT_ROLE"] = agent["role"]

    print(f"\nStarting Amplifier session: {session_id}")
    print(f"Persona context at: {persona_file}")
    print("-" * 60)

    # Start with initial prompt to load persona
    initial_prompt = f"""You are now operating as {agent['display_name']}.

Please read your persona context file to understand your role:
```
cat {persona_file}
```

Then check if there are any tasks waiting for you:
```bash
cd ~/.m365-tenant && uv run --with msal --with httpx --with pyyaml python m365-orchestrator messages --agent {agent['name']}
```

Introduce yourself briefly and await instructions."""

    # Run amplifier
    try:
        subprocess.run(cmd, env=env, cwd=str(Path.home()))
    except KeyboardInterrupt:
        print("\nSession ended")
    finally:
        # Update session status
        session_file = SESSIONS_DIR / f"{args.agent}.json"
        if session_file.exists():
            info = json.loads(session_file.read_text())
            info["status"] = "stopped"
            info["stopped_at"] = datetime.now(timezone.utc).isoformat()
            session_file.write_text(json.dumps(info, indent=2))


if __name__ == "__main__":
    main()
